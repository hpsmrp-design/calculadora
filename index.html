<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Santa Marcelina ‚Äì Calculadora</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --primary:#0ea5e9; --primary-2:#22d3ee; --ok:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;color:var(--text)}

    /* ===== Navbar bonita ===== */
    header{position:sticky;top:0;z-index:10}
    .navbar{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 18px;background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#001018;box-shadow:0 6px 24px rgba(2,132,199,.35)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.3px}
    .brand .logo{width:32px;height:32px;display:grid;place-items:center;border-radius:9px;background:#0010181a}
    .nav-links{display:flex;align-items:center;gap:14px}
    .nav-links a{padding:8px 10px;border-radius:10px;text-decoration:none;color:#001018;font-weight:700;opacity:.9}
    .nav-links a:hover{background:#0010181a;opacity:1}
    .cta{background:#00101814;border:1px solid #00101826}
    .hamburger{display:none;background:transparent;border:0;font-size:22px;cursor:pointer}
    @media (max-width:820px){
      .nav-links{display:none;position:absolute;left:16px;right:16px;top:64px;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:10px}
      .nav-links a{display:block;color:#0f172a}
      .hamburger{display:block;color:#001018}
      .navbar.open .nav-links{display:block}
    }

    .container{max-width:1200px;margin:20px auto;padding:0 16px 40px}
    .layout{display:grid;grid-template-columns: 1.6fr .9fr; gap:16px}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 8px 30px rgba(2,8,23,.06)}
    .item-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .item-title{font-weight:700}
    .price{color:var(--muted);font-size:13px}
    .img{height:78px;display:grid;place-items:center;margin:8px 0}
    .img span{font-size:42px}

    .qty{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:8px}
    .qty button{width:34px;height:34px;border:1px solid var(--line);border-radius:8px;background:#f8fafc;cursor:pointer;font-weight:800}
    .qty input{width:56px;text-align:center;padding:8px;border:1px solid var(--line);border-radius:8px}

    .maxbar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:10px}
    .ghost{border:1px solid var(--line);background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}

    .panel{position:sticky;top:76px;height:max-content}
    .panel .total{font-size:22px;font-weight:900;color:#065f46}
    .panel h3{margin:10px 0 6px}
    .check{display:flex;align-items:center;gap:10px;margin:6px 0}
    .check input{width:18px;height:18px}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{border:1px solid #cbd5e1;background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;cursor:pointer}
    .chip.active{background:#dcfce7;border-color:#86efac;color:#064e3b}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px dashed var(--line);padding:8px 6px;font-size:14px}
    th{text-align:left;color:#475569}
    td:last-child,th:last-child{text-align:right}

    .btn{border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#001018;box-shadow:0 10px 30px rgba(56,189,248,.35)}
    .btn-secondary{background:#e2e8f0}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* ===== Impress√£o: somente a notinha ===== */
    #receipt-wrapper{display:none}
    @media print {
      body * { visibility: hidden !important; }
      #receipt-wrapper, #receipt-wrapper * { visibility: visible !important; }
      #receipt-wrapper { position: absolute; top: 0; left: 0; width: 80mm; margin:0; padding:0 }
    }

    /* Estilo da notinha */
    .receipt{width:80mm; background:#fff; color:#000; padding:10px 12px; border:1px solid #000; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    .receipt h2{font-size:14px; text-align:center; margin:0 0 6px}
    .r-center{text-align:center}
    .r-table{width:100%; border-collapse:collapse; margin-top:6px}
    .r-table th, .r-table td{padding:3px 0; border-bottom:1px dashed #555; text-align:left}
    .r-table td:last-child, .r-table th:last-child{text-align:right}
    .r-line{display:flex; justify-content:space-between; margin-top:4px}
    .r-total{font-weight:800}
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <header>
    <nav class="navbar" id="navbar">
      <div class="brand">
        <div class="logo">üè•</div>
        <div>
          <div style="line-height:1">Hospital Santa Marcelina</div>
          <small style="opacity:.85;font-weight:700">Calculadora &amp; Notinha</small>
        </div>
      </div>
      <button class="hamburger" id="nav-toggle" aria-label="Abrir menu">‚ò∞</button>
      <div class="nav-links" id="nav-links">
        <a href="#sec-med" class="nav-link">Medicamentos</a>
        <a href="#sec-exame" class="nav-link">Exames &amp; Consultas</a>
        <a href="#sec-outros" class="nav-link">Outros</a>
        <a href="#sec-resumo" class="nav-link cta">Resumo</a>
      </div>
    </nav>
  </header>

  <div class="container layout">

    <!-- LISTA DE ITENS (cart√µes) -->
    <section id="grids">
      <a id="sec-med"></a>
      <h3 style="margin:6px 0 8px;color:#334155">Medicamentos</h3>
      <div class="grid" id="grid-med"></div>

      <a id="sec-exame"></a>
      <h3 style="margin:18px 0 8px;color:#334155">Exames & Consultas</h3>
      <div class="grid" id="grid-exame"></div>

      <a id="sec-outros"></a>
      <h3 style="margin:18px 0 8px;color:#334155">Outros</h3>
      <div class="grid" id="grid-outros"></div>
    </section>

    <!-- PAINEL / RESUMO -->
    <aside class="panel card" id="sec-resumo">
      <h3>Total:</h3>
      <div class="total" id="total">R$ 0</div>

      <h3>Descontos</h3>
      <div class="check"><input type="checkbox" id="desc-cnpj"/> <label for="desc-cnpj">Desconto CNPJ (20%)</label></div>
      <div class="check"><input type="checkbox" id="desc-pm"/> <label for="desc-pm">Desconto PM/Arcanjo (40%)</label></div>
      <div class="check"><input type="checkbox" id="desc-plano"/> <label for="desc-plano">Desconto Plano de Sa√∫de (20%)</label></div>

      <div style="margin-top:6px"><small style="color:#334155;font-weight:800">Atalhos</small>
        <div class="chips">
          <button class="chip" id="q-tt">Tratamento (TT)</button>
          <button class="chip" id="q-desl-curto">Desloc. curto (Sul)</button>
          <button class="chip" id="q-desl-longo">Desloc. longo (Norte)</button>
        </div>
      </div>

      <table>
        <thead>
          <tr><th>Resumo</th><th>Valor</th></tr>
        </thead>
        <tbody id="resumo">
          <tr><td>Medicamentos / Insumos</td><td id="sum-med">R$ 0</td></tr>
          <tr><td>Exames</td><td id="sum-exame">R$ 0</td></tr>
          <tr><td>Consultas</td><td id="sum-consulta">R$ 0</td></tr>
          <tr><td>Outros / Procedimentos</td><td id="sum-outros">R$ 0</td></tr>
          <tr><td>Subtotal</td><td id="subtotal">R$ 0</td></tr>
          <tr><td>Descontos</td><td id="val-desc">‚àí R$ 0</td></tr>
          <tr><td><b>Total</b></td><td id="val-total"><b>R$ 0</b></td></tr>
        </tbody>
      </table>

      <div class="bar">
        <button class="btn btn-primary" id="imprimir">Imprimir NOTINHA</button>
        <button class="btn btn-secondary" id="reset">Resetar tudo</button>
      </div>
    </aside>
  </div>

  <!-- NOTINHA (fora do fluxo; usada para print/PNG) -->
  <div id="receipt-wrapper">
    <div id="receipt" class="receipt">
      <h2>Hospital Santa Marcelina</h2>
      <div class="r-center" id="r-meta">CNPJ: 12.345.678/0001-95 ¬∑ Data: --/--/---- --:--</div>
      <table class="r-table" id="r-items">
        <thead>
          <tr><th>Item</th><th>Qtd</th><th>Valor</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="r-line"><span>Subtotal</span><span id="r-subtotal">R$ 0,00</span></div>
      <div class="r-line"><span>Descontos</span><span id="r-desc">R$ 0,00</span></div>
      <div class="r-line r-total"><span>TOTAL</span><span id="r-total">R$ 0,00</span></div>
      <div class="r-center" style="margin-top:6px">Obrigado pela prefer√™ncia!<br/>Este documento n√£o substitui a NFe.</div>
    </div>
  </div>

<script>
  // ===== DADOS (com categoria e limites) =====
  // cat: 'med' | 'exame' | 'consulta' | 'outros'
  const ITENS = [
    // Medicamentos
    {id:'adrenalina',   nome:'Adrenalina',                preco:12000, emoji:'üíâ', cat:'med', max:3,  maxPM:5},
    {id:'analgesico',   nome:'Analg√©sico',                preco:600,   emoji:'üíä', cat:'med', max:10, maxPM:20},
    {id:'atadura',      nome:'Atadura',                   preco:300,   emoji:'ü©π', cat:'med', max:10, maxPM:20},
    {id:'bandagem',     nome:'Bandagem',                  preco:500,   emoji:'ü©∫', cat:'med', max:5,  maxPM:5},
    {id:'kitmed',       nome:'Medkit',                    preco:2500,  emoji:'üß∞', cat:'med', max:2,  maxPM:2},
    {id:'ritmoneury',   nome:'Ritmoneury',                preco:800,   emoji:'üß™', cat:'med', max:5,  maxPM:5},
    {id:'sincalm',      nome:'Sinkalm',                   preco:800,   emoji:'üß¥', cat:'med', max:5,  maxPM:5},
    {id:'ursinho',      nome:'Ursinho',                   preco:30000, emoji:'üß∏', cat:'med', max:99, maxPM:99},

    // Exames & Consultas
    {id:'raiox',        nome:'Raio-X',                    preco:2500,  emoji:'ü©ª', cat:'exame'},
    {id:'ressonancia',  nome:'Resson√¢ncia',               preco:4000,  emoji:'üß†', cat:'exame'},
    {id:'consulta',     nome:'Consulta',                  preco:12000, emoji:'üìã', cat:'consulta'},

    // Outros (sele√ß√£o √∫nica)
    {id:'gesso',        nome:'Gesso',                     preco:2500,  emoji:'üß±', cat:'outros'},
    {id:'cirurgia',     nome:'Cirurgia',                  preco:250000,emoji:'üè•', cat:'outros'},
    {id:'queimadura',   nome:'Queimadura',                preco:2500,  emoji:'üî•', cat:'outros'},
    {id:'outros-exames',nome:'Outros Exames',             preco:3000,  emoji:'üßæ', cat:'outros'},

    // Itens deslocados para a primeira se√ß√£o (toggle)
    {id:'desl-curto',   nome:'Deslocamento curto (Sul)',  preco:1000,  emoji:'üöë', cat:'outros', mode:'toggle', section:'med'},
    {id:'desl-longo',   nome:'Deslocamento longo (Norte)',preco:1500,  emoji:'üöë', cat:'outros', mode:'toggle', section:'med'},
    {id:'tt',           nome:'Tratamento (TT)',           preco:2000,  emoji:'üß∑', cat:'outros', mode:'toggle', section:'med'}
  ];

  const grids = document.getElementById('grids');
  const medGrid = document.getElementById('grid-med');
  const exameGrid = document.getElementById('grid-exame');
  const outrosGrid = document.getElementById('grid-outros');
  const state = new Map(); // id -> qtd (med = n√∫mero; demais = 0/1)
  const fmt = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  const getMaxFor = (item)=>{
    const pm = document.getElementById('desc-pm')?.checked;
    const lim = pm ? (item.maxPM ?? item.max ?? Infinity) : (item.max ?? Infinity);
    return (lim === undefined) ? Infinity : lim;
  };

  function renderCards(){
    medGrid.innerHTML='';
    exameGrid.innerHTML='';
    outrosGrid.innerHTML='';

    ITENS.forEach(it=>{
      const qtd = state.get(it.id)||0;
      const el = document.createElement('div');
      el.className = 'card';

      // decide o tipo de controle: default qty p/ cat 'med'; toggle p/ demais; pode ser sobrescrito por it.mode
      const mode = it.mode ? it.mode : (it.cat==='med' ? 'qty' : 'toggle');

      if(mode === 'qty'){
        const lim = getMaxFor(it);
        const excedido = lim!==Infinity && (qtd>lim);
        el.innerHTML = `
          <div class="item-head">
            <div>
              <div class="item-title">${it.nome}</div>
              <div class="price">(${fmt(it.preco)})</div>
            </div>
            <button class="ghost danger" data-act="zero" data-id="${it.id}">‚àí</button>
          </div>
          <div class="img"><span>${it.emoji}</span></div>
          <div class="qty">
            <button data-act="dec" data-id="${it.id}">‚àí</button>
            <input type="number" min="0" step="1" value="${qtd}" data-id="${it.id}" data-act="input" />
            <button data-act="inc" data-id="${it.id}">+</button>
          </div>
          <div class="maxbar">
            <span style="font-size:12px;color:${excedido?'#b91c1c':'#64748b'}">Limite: normal ${it.max ?? '‚Äî'} / PM ${it.maxPM ?? '‚Äî'}${excedido?' ‚Ä¢ excedido':''}</span>
            <div style="display:flex;gap:6px">
              <button class="ghost" data-act="max-normal" data-id="${it.id}">MAX</button>
              <button class="ghost" data-act="max-pm" data-id="${it.id}">MAX PM</button>
            </div>
          </div>`;
      } else { // toggle
        const ativo = qtd > 0;
        el.innerHTML = `
          <div class="item-head">
            <div>
              <div class="item-title">${it.nome}</div>
              <div class="price">(${fmt(it.preco)} ¬∑ sele√ß√£o √∫nica)</div>
            </div>
          </div>
          <div class="img"><span>${it.emoji}</span></div>
          <div class="maxbar" style="justify-content:center">
            <button class="ghost" data-act="toggle" data-id="${it.id}" style="${ativo?'background:#dcfce7;border-color:#bbf7d0':''}">
              ${ativo? 'Selecionado' : 'Selecionar'}
            </button>
          </div>`;
      }

      // decis√£o de layout (se√ß√£o): se item.section==='med' for√ßa na se√ß√£o inicial
      const section = it.section ? it.section : (it.cat==='med' ? 'med' : (it.cat==='exame' || it.cat==='consulta') ? 'exame' : 'outros');
      if(section==='med') medGrid.appendChild(el);
      else if(section==='exame') exameGrid.appendChild(el);
      else outrosGrid.appendChild(el);
    });
  }

  function somatoriosPorCategoria(){
    const sums = {med:0, exame:0, consulta:0, outros:0};
    state.forEach((q,id)=>{
      const it = ITENS.find(x=>x.id===id); if(!it) return;
      const qty = it.cat==='med' ? q : (q>0?1:0); // meds usam a quantidade; outros = 0/1
      sums[it.cat] += it.preco * qty;
    });
    return sums;
  }

  function calcularTotais(){
    const sums = somatoriosPorCategoria();
    let subtotal = sums.med + sums.exame + sums.consulta + sums.outros;

    const dCNPJ = document.getElementById('desc-cnpj').checked ? .20 : 0;
    const dPM   = document.getElementById('desc-pm').checked ? .40 : 0;
    const dPlano= document.getElementById('desc-plano').checked ? .20 : 0; // Plano 20%
    const descRate = Math.max(dCNPJ, dPM, dPlano, 0); // aplica somente o MAIOR

    const desconto = subtotal * descRate;
    const total = subtotal - desconto;
    return {sums, subtotal, desconto, total, descRate};
  }

  function atualizarUI(){
    const {sums, subtotal, desconto, total} = calcularTotais();
    document.getElementById('sum-med').textContent = fmt(sums.med);
    document.getElementById('sum-exame').textContent = fmt(sums.exame);
    document.getElementById('sum-consulta').textContent = fmt(sums.consulta);
    document.getElementById('sum-outros').textContent = fmt(sums.outros);
    document.getElementById('subtotal').textContent = fmt(subtotal);
    document.getElementById('val-desc').textContent = '‚àí ' + fmt(desconto);
    document.getElementById('total').textContent = fmt(total);
    document.getElementById('val-total').innerHTML = '<b>'+fmt(total)+'</b>';
  }

  function montarRecibo(){
    const {subtotal, desconto, total} = calcularTotais();
    const now = new Date();
    const pad = n => String(n).padStart(2,'0');
    document.getElementById('r-meta').textContent = `CNPJ: 12.345.678/0001-95 ¬∑ Data: ${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    const tbody = document.querySelector('#r-items tbody');
    tbody.innerHTML='';
    state.forEach((q,id)=>{
      const it = ITENS.find(x=>x.id===id);
      if(!it || q<=0) return;
      const qty = it.cat==='med' ? q : 1; // na notinha, itens selecion√°veis contam 1
      const line = it.preco*qty;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.nome}</td><td>${qty}</td><td>${fmt(line)}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('r-subtotal').textContent = fmt(subtotal);
    document.getElementById('r-desc').textContent     = '‚àí ' + fmt(desconto);
    document.getElementById('r-total').textContent    = fmt(total);
  }

  function syncQuick(){
    const set=(id,el)=>{ const v = state.get(id)||0; if(el){ el.classList.toggle('active', v>0); } };
    set('tt', document.getElementById('q-tt'));
    set('desl-curto', document.getElementById('q-desl-curto'));
    set('desl-longo', document.getElementById('q-desl-longo'));
  }
  function recalc(){ atualizarUI(); montarRecibo(); syncQuick(); }

  // Eventos dos cart√µes (delega√ß√£o em #grids)
  grids.addEventListener('click', (e)=>{
    const act = e.target.getAttribute('data-act');
    if(!act) return;
    const id = e.target.getAttribute('data-id');
    const item = ITENS.find(x=>x.id===id);
    const qtd = state.get(id)||0;

    if(act==='inc' && item?.cat==='med'){ state.set(id, (qtd+1)); }
    if(act==='dec' && item?.cat==='med'){ state.set(id, Math.max(0, qtd-1)); }
    if(act==='zero'){ state.delete(id); }
    if(act==='max-normal' && item?.cat==='med'){ const lim=(item.max ?? (state.get(id)||0)); state.set(id, lim); }
    if(act==='max-pm' && item?.cat==='med'){ const lim=(item.maxPM ?? (state.get(id)||0)); state.set(id, lim); }
    if(act==='toggle' && item && item.cat!=='med'){ state.set(id, qtd>0 ? 0 : 1); }

    renderCards(); recalc();
  });

  grids.addEventListener('change', (e)=>{
    const act = e.target.getAttribute('data-act');
    if(act==='input'){
      const id = e.target.getAttribute('data-id');
      const it = ITENS.find(x=>x.id===id);
      const val = Math.max(0, parseInt(e.target.value||'0',10));
      const mode = it?.mode ? it.mode : (it?.cat==='med' ? 'qty' : 'toggle');
      if(it && mode==='qty'){
        state.set(id, val);
        renderCards(); recalc();
      } else {
        e.target.value = state.get(id)||0;
      }
    }
  });

  // Painel
  document.getElementById('reset').addEventListener('click',()=>{
    state.clear();
    ['desc-cnpj','desc-pm','desc-plano'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.checked=false;
    });
    renderCards(); recalc();
  });

  // Quick actions (atalhos)
  (function attachQuick(){
    const btnTT = document.getElementById('q-tt');
    const btnCurto = document.getElementById('q-desl-curto');
    const btnLongo = document.getElementById('q-desl-longo');
    if(btnTT){ btnTT.addEventListener('click',()=>{ const v=state.get('tt')||0; state.set('tt', v?0:1); recalc(); }); }
    if(btnCurto){ btnCurto.addEventListener('click',()=>{ const v=state.get('desl-curto')||0; state.set('desl-curto', v?0:1); recalc(); }); }
    if(btnLongo){ btnLongo.addEventListener('click',()=>{ const v=state.get('desl-longo')||0; state.set('desl-longo', v?0:1); recalc(); }); }
  })();

  // Navbar: toggle + scroll suave
  (function initNavbar(){
    const nav = document.getElementById('navbar');
    const toggle = document.getElementById('nav-toggle');
    const links = document.querySelectorAll('.nav-link');
    if(toggle){ toggle.addEventListener('click',()=>{ nav.classList.toggle('open'); }); }
    links.forEach(a=>a.addEventListener('click', (e)=>{
      const href = a.getAttribute('href');
      if(href && href.startsWith('#')){
        e.preventDefault();
        const el = document.querySelector(href);
        if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
        nav.classList.remove('open');
      }
    }));
  })();

  // Bot√£o: gerar PNG e abrir imgbb
  async function salvarPNG_ENVIAR(){
    montarRecibo();
    const wrap = document.getElementById('receipt-wrapper');
    const prev = wrap.style.display; wrap.style.display = 'block';
    const canvas = await html2canvas(document.getElementById('receipt'), {backgroundColor:'#fff', scale:2});
    const dataURL = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = dataURL; a.download = `notinha-santa-marcelina-${Date.now()}.png`; a.click();
    wrap.style.display = prev || 'none';
    window.open('https://pt-br.imgbb.com/', '_blank');
  }
  document.getElementById('imprimir').addEventListener('click', salvarPNG_ENVIAR);

  // Inicializa
  renderCards(); recalc();
</script>
</body>
</html>
